import React from 'react'
import './App.css'
import { rgb2hex } from './utils'

const CONTROL_CODE = ['ControlLeft', 'ControlRight']
/**
 *
 * @param {object} param0
 * @returns
 */
const PointLabel = ({ x, y }) => {
  return <div className="">图片坐标: {`(${x}, ${y})`}</div>
}

/**
 *
 * @param {object} param0
 * @returns
 */
const ColorLabel = ({ r, g, b }) => {
  const c = rgb2hex(r, g, b)
  const size = '20px'
  return (
    <div className="flex content-center ">
      hex:
      <span>{c}</span>
      <div
        style={{
          width: size,
          height: size,
          marginLeft: '5px',
          backgroundColor: c,
          display: 'inline-block',
        }}
      ></div>
    </div>
  )
}

class Canvas extends React.Component {
  constructor(props) {
    super(props)
    this.canvasRef = null
    this.ctx = null
    this.preObjURL = null
  }

  /**
   *
   * @param {MouseEvent} evt
   */
  handleMouseMove(evt) {
    if (this.props.isCtrlDown()) {
      return
    }
    if (!this.ctx) {
      return
    }
    const { x, y } = this.getMousePonint(evt)
    const data = this.ctx.getImageData(x, y, 1, 1).data
    const [r, g, b, alpha] = data
    return this.props.handleMouseMove({ x, y, r, g, b })
  }

  componentDidUpdate() {
    if (!this.props.objURL) {
      return
    }
    if (!!this.preObjURL && this.preObjURL === this.preObjURL) {
      return
    }
    this.preObjURL = this.props.objURL

    this.ctx = this.canvasRef.getContext('2d')
    const img = new Image()
    img.src = this.props.objURL
    img.onload = () => {
      this.canvasRef.width = img.width
      this.canvasRef.height = img.height
      this.ctx.drawImage(img, 0, 0)
    }
  }

  /**
   *
   * @param {MouseEvent} evt
   * @returns
   */
  getMousePonint(evt) {
    const rect = this.canvasRef.getBoundingClientRect()
    // BUG rect.top may return float
    return {
      x: evt.clientX - Math.round(rect.left),
      y: evt.clientY - Math.round(rect.top),
    }
  }
  render() {
    return (
      <canvas
        ref={(ref) => {
          this.canvasRef = ref
        }}
        onMouseMove={(evt) => this.handleMouseMove(evt)}
      ></canvas>
    )
  }
}

class App extends React.Component {
  constructor(props) {
    super(props)
    this.isCtrlDown = false
    this.state = {
      r: 0,
      g: 0,
      b: 0,
      x: 0,
      y: 0,
      objURL: null,
    }
    document.addEventListener('keydown', (evt) => {
      if (CONTROL_CODE.includes(evt.code)) {
        this.isCtrlDown = true
      }
    })
    document.addEventListener('keyup', (evt) => {
      if (CONTROL_CODE.includes(evt.code)) {
        this.isCtrlDown = false
      }
    })
  }

  /**
   *
   * @param {Event} evt
   * @returns
   */
  showImage(evt) {
    if (!evt) {
      return
    }

    const files = evt.target.files
    if (!files.length) {
      return
    }

    this.setState({ objURL: URL.createObjectURL(files[0]) })
  }

  componentDidMount() {
    this.showImage()
  }

  render() {
    return (
      <div>
        <Canvas
          isCtrlDown={() => this.isCtrlDown}
          objURL={this.state.objURL}
          handleMouseMove={({ x, y, r, g, b }) =>
            this.setState({ x, y, r, g, b })
          }
        />
        <PointLabel x={this.state.x} y={this.state.y} />
        <ColorLabel r={this.state.r} g={this.state.g} b={this.state.b} />
        <input type="file" onChange={(evt) => this.showImage(evt)} />
        <p></p>
        <div>按住 ctrl 暂停更新坐标 图片太大的话使用 chrome 自带的缩放</div>
        <div>bar</div>
      </div>
    )
  }
}

export default App
